name: CI
on:
  pull_request:
  workflow_dispatch:
  push:
    tags:
      - "*"
    branches:
      - main

permissions:
  contents: read   # default for all jobs unless overridden

env:
  MAIN_PYTHON_VERSION: "3.13"
  DOCUMENTATION_CNAME: 'twin.docs.pyansys.com'
  LIBRARY_NAME: 'pytwin'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
  

jobs:

  doc-build:
    name: "Build documentation"
    runs-on: pytwin-win10
    steps:
      - name: "Install Git and clone project"
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: "Set up Python"
        uses: ansys/actions/_setup-python@v10.1
        with:
          python-version: ${{ env.MAIN_PYTHON_VERSION }}
          use-cache: false

      - name: "Copy source files for DPF server installation"
        shell: bash
        run: |
          cp -r ~ansys/Documents/devEnv/pyansys/pytwin/ansys_dpf_server_win_v2024.1.pre0/ ./
          
      - name: "Create virtual environment and Install Python library"
        run: |
          python -m venv .venv --clear
          .venv\Scripts\Activate.ps1
          python -m pip install pip -U
          python -m pip install poetry

      - name: "Install documentation dependencies, including DPF server"
        run: |
          .venv\Scripts\Activate.ps1
          poetry install --extras graphics --with doc
          cd ansys_dpf_server_win_v2024.1.pre0
          pip install -e .
          cd ..

      - name: Setup headless display
        uses: pyvista/setup-headless-display-action@7d84ae825e6d9297a8e99bdbbae20d1b919a0b19 # v4.2

      - name: "Clean documentation build folder"
        run: |
          .venv\Scripts\Activate.ps1
          doc/make.bat clean

      - name: "Build HTML documentation"
        run: |
          .venv\Scripts\Activate.ps1
          doc/make.bat html
          if (Select-String -Path "doc/build_errors.txt" -Pattern "Traceback|ERROR|Error|error|Exception") {
            Write-Error "Documentation build failed due to detected errors in doc/build_errors.txt"
            exit 1
          }
        env:
          ANSYS_DPF_ACCEPT_LA: Y

      - name: "Upload HTML documentation artifact"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: documentation-html
          path: doc/_build/html
          retention-days: 7